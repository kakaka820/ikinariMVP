<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>アンケート統合ログイン</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { sha256 } from "https://cdn.skypack.dev/js-sha256";

    const firebaseConfig = {
      apiKey: "AIzaSyDs3xNPpmdzqD1nww2s6mIPbYHtsRvXeY0",
      authDomain: "ikinarimvp.firebaseapp.com",
      projectId: "ikinarimvp",
      storageBucket: "ikinarimvp.appspot.com",
      messagingSenderId: "587616153202",
      appId: "1:587616153202:web:5b6cbc5ca3ac3e8c42dceb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.currentUser = null;

    signInAnonymously(auth)
      .then(() => console.log("匿名ログイン成功"))
      .catch((error) => {
        alert("認証エラーが発生しました");
        console.error(error);
      });

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      window.currentUser = user.uid;
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("userId").value = data.userId || "";
        if (data.answers) {
          for (let i = 1; i <= 3; i++) {
            document.querySelector(`input[name=q${i}][value="${data.answers[`q${i}`]}"]`)?.click();
          }
        }
        document.getElementById("comment").value = data.comment || "";
      }
      document.getElementById("loginSection").classList.remove("hidden");
    });

    window.login = async () => {
      const inputId = document.getElementById("userId").value.trim();
      const inputPw = document.getElementById("password").value;
      const hash = sha256(inputPw);

      const userRef = doc(db, "users", window.currentUser);
      const userData = await getDoc(userRef);

      if (userData.exists() && userData.data().userId === inputId && userData.data().passwordHash === hash) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("formSection").classList.remove("hidden");
      } else {
        document.getElementById("loginError").textContent = "ログイン失敗：IDまたはパスワードが違います。";
      }
    };

    window.register = async () => {
      const newId = document.getElementById("newUserId").value.trim();
      const newPw = document.getElementById("newPassword").value;
      if (!newId || !newPw) {
        document.getElementById("registerMessage").textContent = "IDとパスワードを入力してください。";
        return;
      }

      const hash = sha256(newPw);
      const userRef = doc(db, "users", window.currentUser);

      await setDoc(userRef, {
        userId: newId,
        passwordHash: hash,
        answers: {},
        comment: ""
      });

      document.getElementById("registerSection").classList.add("hidden");
      document.getElementById("formSection").classList.remove("hidden");
    };

    window.submitForm = async () => {
      const answers = {
        q1: document.querySelector("input[name=q1]:checked")?.value || "",
        q2: document.querySelector("input[name=q2]:checked")?.value || "",
        q3: document.querySelector("input[name=q3]:checked")?.value || "",
      };
      const comment = document.getElementById("comment").value;

      const userRef = doc(db, "users", window.currentUser);
      await setDoc(userRef, {
        ...(await getDoc(userRef)).data(),
        answers,
        comment
      });
      alert("回答を保存しました");
    };

    window.showRegister = () => {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("registerSection").classList.remove("hidden");
    };

    window.backToLogin = () => {
      document.getElementById("registerSection").classList.add("hidden");
      document.getElementById("loginSection").classList.remove("hidden");
    };
  </script>
  <style>
    .hidden { display: none; }
    .container { margin: 20px; }
  </style>
</head>
<body>
  <div class="container hidden" id="loginSection">
    <h2>ログイン</h2>
    <input type="text" id="userId" placeholder="ID" /><br><br>
    <input type="password" id="password" placeholder="パスワード" /><br><br>
    <button onclick="login()">ログイン</button>
    <button onclick="showRegister()">新規登録</button>
    <p id="loginError" style="color: red;"></p>
  </div>

  <div class="container hidden" id="registerSection">
    <h2>新規アカウント作成</h2>
    <input type="text" id="newUserId" placeholder="新しいID" /><br><br>
    <input type="password" id="newPassword" placeholder="パスワード" /><br><br>
    <button onclick="register()">登録</button>
    <button onclick="backToLogin()">戻る</button>
    <p id="registerMessage" style="color: red;"></p>
  </div>

  <div class="container hidden" id="formSection">
    <h2>アンケート</h2>
    <form onsubmit="event.preventDefault(); submitForm();">
      <p>5/30</p>
      <label><input type="radio" name="q1" value="〇"> 〇</label>
      <label><input type="radio" name="q1" value="△"> △</label>
      <label><input type="radio" name="q1" value="✕"> ✕</label>

      <p>Q2: よく使うSNSは？</p>
      <label><input type="radio" name="q2" value="〇"> 〇</label>
      <label><input type="radio" name="q2" value="△"> △</label>
      <label><input type="radio" name="q2" value="✕"> ✕</label>

      <p>Q3: よく使う動画サービスは？</p>
      <label><input type="radio" name="q3" value="〇"> 〇</label>
      <label><input type="radio" name="q3" value="△"> △</label>
      <label><input type="radio" name="q3" value="✕"> ✕</label>

      <p>コメント:</p>
      <textarea id="comment" rows="4" cols="50" placeholder="自由にご記入ください"></textarea><br><br>
      <button type="submit">送信</button>
    </form>
  </div>
</body>
</html>
